<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">

<!-- head 영역 시작 -->
<!-- 개별적으로 사용할 css, js 링크 걸기 위해 남겨둠 -->

<head>
	<th:block layout:fragment="script">
		<script th:inline="javascript">
			$(function () {
				let list = $('.post').get();
				let flagList = [];
				
				for(let i=0; i < list.length; i++) {
					flagList.push(false);
				}
				console.log(list.length);
				//퀼 텍스트 에어리어 소환
				new Quill('.quill-editor-default', {
					theme: 'bubble'
				});
				//게시글에서 메세지버튼 누르면 메세지 창 나옴
				$("#msg_btn").click(function (e) {
					$('#msgModal').modal("show");
				})
				
				//게시글 작성에서 사진 버튼 누르면 input-file 실행
				$("#file_select_btn").click(function (e) {
					$("#file_select").click();
				})

				
				for(let i=0; i < list.length; i++) {
					
					$($('.updateBtn')[i]).click(function(e) {

						flagList[i] = !flagList[i];
						if(flagList[i]) {
							$(this).text("돌아가기");
							$("<button id='deleteButton" + $(this).val() + "'>").appendTo($(this).parent());
							$("#deleteButton" + $(this).val()).text("글 삭제");
							$("<button id='updateButton" + $(this).val() + "'>").appendTo($(this).parent());
							$("#updateButton" + $(this).val()).text("게시글 수정하기");
						} else {
							$(this).text("게시글 수정")	
							$("#deleteButton" + $(this).val()).remove();
							$("#updateButton" + $(this).val()).remove();
						}
						console.log("수정 버튼 클릭 해당 게시글 활성화 " + i + "번 글 활성");
						if(!flagList[i]) {
							$("#postContent" + $(this).val()).show();
							$("#contentIn" + $(this).val()).hide();
						} else {
							$("#postContent" + $(this).val()).hide();
							$("#contentIn" + $(this).val()).show();
						}
					});
				}
				
				for(let i=0; i < list.length; i++) {
					$("#updateButton" + i).click(function(e) {
						$($('.data')[i]).fnUpdatePost(i);
					});
					$("#deleteButton" + i).click(function(e) {
						$($('.data')[i]).submit();
					});
				}	
			});
			
			function fnUpdatePost(size) {	//파일 입출력이나 수정을 위한 ajax 데이터 묶음 처리
				dt = new DataTransfer();
					
				for(f in uploadFiles) {
					let file = uploadFiles[f];
					dt.items.add(file);
				}
				
				$("#btnAtt")[0].files = dt.files;
				
				//dt.clearData();
				//clearData() 사용하면 배열의 모든 내용이 담기지 않고
				//파일 하나씩만 담기는 현상이 발생해서 dt를 두 개로 분리하여 사용
				dt2 = new DataTransfer();
				
				for(f in changedFiles) {
					let file = changedFiles[f];
					dt2.items.add(file);
				}
				
				$("#changedFiles")[0].files = dt2.files;
				
				//변경된 파일정보와 삭제된 파일정보를 담고있는 배열 전송
				//배열 형태로 전송 시 백단(Java)에서 처리불가
				//JSON String 형태로 변환하여 전송한다.
				$("#originFiles").val(JSON.stringify(originFiles));
				
				//ajax에서 multipart/form-data형식을 전송하기 위해서는
				//new FormData()를 사용하여 직접 폼데이터 객체를 만들어준다.
				//form.serialize()는 multipart/form-data 전송불가
				//let formData = new FormData($("#updateForm")[0]);
				let formData = [];
				//for(let i = 0; i < size; i++) {
					formData.push(new FormData($($(".data")[i])));
				//}
				
				//ajax에 enctype: multipart/form-data, 
				//processData: false, contentType: false로 설정					
				$.ajax({
					enctype: 'multipart/form-data',
					url: '/post/updatePost',
					type: 'put',
					data: formData,
					processData: false,
					contentType: false,
					success: function(obj) {
						console.log(obj);
						alert("수정작업을 성공하였습니다.");
						$("#postId").val(obj.item.getPost.postId);
						$("#userId").val(obj.item.getPost.userId);
						$("#postContentIn").text(obj.item.getPost.postContent);
						$("#restNmIn").val(obj.item.getPost.restNm);
						$("#boardRegdateText").text(obj.item.getPost.boardRegdate == null ?
													'' :
													obj.item.boardRegdate.substring(0, 10));
						$("#boardCntText").text(obj.item.getPost.boardCnt);
						$("#boardRegdate").val(obj.item.getPost.boardRegdate);
						$("#boardCnt").val(obj.item.getPost.boardCnt);
					},
					error: function(e) {
						console.log(e);
					},
					done: function(result) {
						console.log(result);
						$("#attZone").replaceWith(result);
					}
				});
			}
		</script>
	</th:block>
<!--#targetPost .post {
	
	height: 100%; 
}
#targetPost .card, #targetPost .recent-sales {
  	height: 70%;
  	font-size: 14px;
}

#targetPost .card-body {
	height: 70%;
}-->

</head>
<!-- head 영역 끝 -->

<body>

	<main layout:fragment="main" id="main" class="main">
		<div id="selectedPost">
			
		</div>
		<div class="pagetitle">
			<h1>HOME</h1>
		</div><!-- End Page Title -->

		<section class="section dashboard">
			<div class="row">
				<!--왼쪽 라인을 8로 오른쪽 라인을 4 비율로 나눔(페이지 100% = 12)-->
				<!-- Left side columns -->
				<div class="col-lg-8">
					<div class="row">
						<!-- Recent Sales -->
						<div class="col-12">
							<!-- 작성 하는 부분 -->
							<div class="card recent-sales overflow-auto">
								<div class="card-body">
									<h5 class="card-title">What's happening?</h5>
									<!-- Quill Editor Default(퀼 에디터 텍스트 에어리어) -->
									<div style="border-radius: 8px;">
										<div class="quill-editor-default">
											<h2>write your daily life</h2>
										</div>
									</div>
									<!-- End Quill Editor Default -->
									<br>
									<!-- 게시글 작성을 form 으로 넘길예정 hidden으로 텍스트 에어리어 값을 받아올것임 -->
									<form style="float: right; margin-bottom: -13px; margin-top: -13px">
										<input type="file" id="file_select" style="display: none;">
										<!-- 이미지에 클릭 이벤트를 넣어서 클릭시 타입 파일 실행 -->
										<i id="file_select_btn" class="ri-image-2-line"
											style="font-size: 30px; color: black; cursor: pointer; vertical-align:middle;">
										</i>
										<!--버튼에 submit 스크립트 넣을예정-->
										<input type="button" class="btn" value="작성"
											style="background-color: #4154f1; color: white;">
									</form>
								</div>
							</div>
						</div><!-- End Recent Sales -->
					</div>
					<div class="row">
						<div th:each="post : ${postList}" class="col-12 post">
							<div class="card recent-sales">
								<div class="card-body">
									<!-- 오른쪽 정렬된 시간, 드롭다운 버튼 -->
									<div class="filter" style="margin-top: 15px;">
										<a style="margin-right: 20px;">30분전</a>
										<a class="icon" href="#" data-bs-toggle="dropdown"><i
												class="bi bi-three-dots"></i></a>
										<ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
											<li><a class="dropdown-item" href="#"><i
														class="ri-alarm-warning-line"></i>&emsp;신고하기</a></li>
										</ul>
									</div>
									<!-- 이름부분 후에 스크립트로 for문 예정 -->
									<div class="card-title">
										<img class="img-fluid rounded-circle" src="../assets/img/messages-1.jpg"
											style="width: 40px;">
										<input type="hidden" class="restNm" value="">
										<a href="#" class="card-title" th:text="${post.restNm}"></a>
									</div>
									<!-- 게시글 사진 부분 -->
									<div class="activity" style="margin-bottom: 10px;">
										<img src="../assets/img/news-1.jpg" style="width: 100%;">
									</div>
									<div class="activity">
										<!-- 게시글 내용부분-->
										<div th:id="'postContent' + ${post.postId}" th:text="${post.postContent}"></div>
										<textarea th:id="'contentIn' + ${post.postId}" name="contentIn" col="200" row="40" th:text="${post.postContent}" style="display: none; resize: none;"></textarea>
										
										<br>
										<!-- 해시태그 -->
										<a href="#" style="color: blue;">&emsp;#강남맛집</a>
										<a href="#" style="color: blue;">&emsp;#˘ᗜ˘</a>
										<a href="#" style="color: blue;">&emsp;#(๑╹ワ╹)</a>
									</div>
									<!-- 좋아요 댓글 아이콘 -->
									<div class="activity">
										<a href="#"><i class="ri-heart-3-line"
												style="font-size: 30px; margin-right: 5px; color:black"></i></a>
										<a href="#" id="msg_btn"><i class="ri-message-3-line"
												style="font-size: 30px; margin-right: 5px; color:black;"></i></a>
										<a href="#"><i class="ri-send-plane-2-line"
												style="font-size: 30px; margin-right: 5px; color:black;"></i></a>
										<br>
										<!--좋아요 숫자 필드-->
										<a>좋아요 <span>21</span>개</a>
										<hr>
									</div>
									<!-- 내부 서버로 옮기는 데이터를 모음. 추후에 이미지도 다룸. -->
									<form class="data" action="/post/updatePost" th:method="post">
										<input type="hidden" id="restNmIn" name="restNm" value="${post.restNm}">
										<input type="hidden" id="postContentIn" name="postContent" value="${post.postContent}">
										<input type="hidden" id="userId" name="userId" value="${post.userId}">
										<input type="hidden" id="postId" name="postId" value="${post.postId}">
									</form>
									<!-- 친구 식사 했는지 확인 필드 -->
									<div class="activity" style="text-align: center;">
										<a href="#"><span>six</span>님 외 16명이 <span>서울 강남구 강남대로 36</span>
											<span>감성타코</span>에서 식사하셨어요!</a>
										<input type="hidden" class="test" value="">
										<button class="updateBtn" id="updateButton" th:value="${post.postId}" th:if="${post.userId} eq ${loginUser.userId}">게시글 수정</button>	
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="newPost">
						<a th:href="@{/post/newPost}">새글 쓰기</a>
					</div>
				</div><!-- End Left side columns -->

				<!-- Right side columns -->
				<div class="col-lg-4 col-xxl-3">

					<!-- Recent Activity -->
					<div class="card">
						<div class="card-body">
							<h5 class="card-title" style="text-align: center; font-size: larger; font-weight: bold; margin-top:10px;">지금 뜨는 먹거리 <span>| Today</span></h5>
							<div class="activity">
								<div id="today_eat">
									<ol>
									<!--
										<li><a href="#">#치킨</a></li>
										<li><a href="#">#보쌈</a></li>
										<li><a href="#">#연어초밥</a></li>
										<li><a href="#">#우육면</a></li>
										<li><a href="#">#마라탕</a></li>
										<li><a href="#">#짜장면</a></li>
										<li><a href="#">#라멘</a></li>
										<li><a href="#">#갈비</a></li>
										<li><a href="#">#곱창</a></li>
										<li><a href="#">#막창</a></li> -->
										
										<li><a href="#"><b>#치킨</b></a></li>
										<li><a href="#"><b>#보쌈</b></a></li>
										<li><a href="#"><b>#연어초밥</b></a></li>
										<li><a href="#"><b>#우육면</b></a></li>
										<li><a href="#"><b>#마라탕</b></a></li>
										<li><a href="#"><b>#짜장면</b></a></li>
										<li><a href="#"><b>#라멘</b></a></li>
										<li><a href="#"><b>#갈비</b></a></li>
										<li><a href="#"><b>#곱창</b></a></li>
										<li><a href="#"><b>#막창</b></a></li>
										
									</ol>
								</div>

							</div>

						</div>
					</div><!-- End Recent Activity -->
				</div><!-- End Right side columns -->


			</div>
		</section>
		<!-- 댓글 모델 -->
		<div class="modal fade" id="msgModal" role="dialog">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<!-- 댓글 작성 폼 -->
						<form class="form-inline" role="form">
							<input type="text" placeholder="댓글을 작성하세요!!" onfocus="this.placeholder=''"
								onblur="this.placeholder='댓글을 작성하세요!!'">
							<input type="submit" class="btn" value="작성">
						</form>
					</div>
					<!-- 댓글 들어가는곳 -->
					<div class="modal-body overflow-auto">
						<div id="comment" style="max-height: 30em;">
							<div class="comment_info" style="margin-bottom: 20px;">
								<img class="img-fluid rounded-circle" src="../assets/img/messages-2.jpg"
									style="width: 40px;">
								<span style="margin-left: 10px;">머글랭</span>
								<div>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit, ullam recusandae
									odit suscipit cumque nihil nulla ipsam obcaecati doloremque temporibus vel magni et
									cupiditate repudiandae esse ea repellat, laudantium inventore!</div>
							</div>
							<div class="comment_info" style="margin-bottom: 20px;">
								<img class="img-fluid rounded-circle" src="../assets/img/messages-1.jpg"
									style="width: 40px;">
								<span style="margin-left: 10px;">머글랭</span>
								<div>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit, ullam recusandae
									odit suscipit cumque nihil nulla ipsam obcaecati doloremque temporibus vel magni et
									cupiditate repudiandae esse ea repellat, laudantium inventore!</div>
							</div>
							<div class="comment_info" style="margin-bottom: 20px;">
								<img class="img-fluid rounded-circle" src="../assets/img/messages-3.jpg"
									style="width: 40px;">
								<span style="margin-left: 10px;">머글랭</span>
								<div>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit, ullam recusandae
									odit suscipit cumque nihil nulla ipsam obcaecati doloremque temporibus vel magni et
									cupiditate repudiandae esse ea repellat, laudantium inventore!</div>
								<div>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit, ullam recusandae
									odit suscipit cumque nihil nulla ipsam obcaecati doloremque temporibus vel magni et
									cupiditate repudiandae esse ea repellat, laudantium inventore!</div>
								<div>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit, ullam recusandae
									odit suscipit cumque nihil nulla ipsam obcaecati doloremque temporibus vel magni et
									cupiditate repudiandae esse ea repellat, laudantium inventore!</div>
								<div>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit, ullam recusandae
									odit suscipit cumque nihil nulla ipsam obcaecati doloremque temporibus vel magni et
									cupiditate repudiandae esse ea repellat, laudantium inventore!</div>
								<div>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit, ullam recusandae
									odit suscipit cumque nihil nulla ipsam obcaecati doloremque temporibus vel magni et
									cupiditate repudiandae esse ea repellat, laudantium inventore!</div>
							</div>
						</div>
					</div>
				</div>
			</div>

	</main><!-- End #main -->
</body>














</html>